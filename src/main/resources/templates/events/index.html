<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

<head>
    <title>All Events</title>
    <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Get events data from Thymeleaf
            const events = /*[[${events}]]*/ [];
            
            if (events.length > 0) {
                // Initialize Mapbox
                mapboxgl.accessToken = 'pk.eyJ1Ijoia2FsbWFuaS1tYW5jaGVzdGVyIiwiYSI6ImNtOHlnMHk0eDAwdHgyanIwY2c3dDV0bTEifQ.4QM0YZeknSfKTVhsmJ3pCg';
                
                try {
                    // Calculate bounds to show all events
                    const bounds = new mapboxgl.LngLatBounds();
                    events.forEach(event => {
                        if (event.venue && event.venue.longitude && event.venue.latitude) {
                            bounds.extend([event.venue.longitude, event.venue.latitude]);
                        }
                    });

                    // Initialize map
                    const map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/mapbox/streets-v12',
                        bounds: bounds,
                        fitBoundsOptions: {
                            padding: 50
                        }
                    });
                    
                    // Add markers for each event
                    events.forEach(event => {
                        if (event.venue && event.venue.longitude && event.venue.latitude) {
                            const popup = new mapboxgl.Popup({ offset: 25 })
                                .setHTML(`<h5>${event.name}</h5><p>${event.date} ${event.time || ''}</p>`);
                            
                            new mapboxgl.Marker({ color: '#E02040' })
                                .setLngLat([event.venue.longitude, event.venue.latitude])
                                .setPopup(popup)
                                .addTo(map);
                        }
                    });
                    
                    // Add navigation controls
                    map.addControl(new mapboxgl.NavigationControl());
                } catch (error) {
                    console.error('Error initializing map:', error);
                    document.getElementById('map').innerHTML = 
                        `<div class="alert alert-danger text-center p-5">Error initializing map: ${error.message}</div>`;
                }
            } else {
                document.getElementById('map').innerHTML = 
                    '<div class="alert alert-warning text-center p-5">No upcoming events to display on the map.</div>';
            }
        });
    </script>

    <style>
        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .mapboxgl-popup {
            max-width: 200px;
        }
        .mapboxgl-popup-content {
            text-align: center;
            padding: 15px;
        }
    </style>
</head>

<body>
    <div layout:fragment="content" class="container py-4">
        
        <!-- Top Navigation -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="/venues" class="btn btn-outline-primary">
                <i class="fa-solid fa-building"></i> View Venues
            </a>
            <h1 class="mb-0 text-center flex-grow-1">All Events</h1>
            <a href="/events/new_event" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i> Add New Event
            </a>
        </div>

        <!-- Search Bar -->
        <div class="row mb-4">
            <div class="col-lg-6 offset-lg-3">
                <form class="input-group" th:action="@{/events/search}" method="get">
                    <input class="form-control" type="search" name="query" placeholder="Search Events" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">
                        <i class="fa-solid fa-search"></i> Search
                    </button>
                </form>
            </div>
        </div>

        <!-- Upcoming Events Section -->
        <h2 class="mt-4">Upcoming Events</h2>
        <div th:if="${events.?[date != null and date.isAfter(T(java.time.LocalDate).now())].size() > 0}" class="mb-4">
            <table class="table table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th><i class="fa-solid fa-bolt"></i> Event</th>
                        <th><i class="fa-solid fa-map-marker-alt"></i> Venue</th>
                        <th><i class="fa-solid fa-calendar"></i> Date</th>
                        <th><i class="fa-solid fa-clock"></i> Time</th>
                    </tr>
                </thead>
                <tbody>
					<tr th:each="e : ${events}" th:if="${(e.date.isAfter(T(java.time.LocalDate).now()) or (e.date.isEqual(T(java.time.LocalDate).now()) and e.time != null and e.time.isAfter(T(java.time.LocalTime).now())))}" th>
                        <td><a th:href="@{/events/{id}/details(id=${e.id})}" class="text-decoration-none" th:text="${e.name}">Event Name</a></td>
                        <td><a th:href="@{/venues/{id}/details(id=${e.venue.id})}" class="text-decoration-none" th:text="${e.venue.name}">Venue</a></td>
                        <td th:text="${e.date}">Event Date</td>
                        <td th:text="${e.time}">Event Time</td>
                    </tr>
                </tbody>
            </table>
        </div>
		<div th:if="${events.?[date != null and (date.isAfter(T(java.time.LocalDate).now()) or (date.isEqual(T(java.time.LocalDate).now()) and time != null and time.isAfter(T(java.time.LocalTime).now())))].empty}">
            <p class="text-muted text-center">There are no upcoming events.</p>
        </div>

        <!-- Previous Events Section -->
        <h2 class="mt-4">Previous Events</h2>
        <div th:if="${events.?[date != null and date.isBefore(T(java.time.LocalDate).now())].size() > 0}" class="mb-4">
            <table class="table table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th><i class="fa-solid fa-bolt"></i> Event</th>
                        <th><i class="fa-solid fa-map-marker-alt"></i> Venue</th>
                        <th><i class="fa-solid fa-calendar"></i> Date</th>
                        <th><i class="fa-solid fa-clock"></i> Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="e : ${events}" th:if="${e.date != null and e.date.isBefore(T(java.time.LocalDate).now())}">
                        <td><a th:href="@{/events/{id}/details(id=${e.id})}" class="text-decoration-none" th:text="${e.name}">Event Name</a></td>
                        <td th:text="${e.venue.name}">Venue</td>
                        <td th:text="${e.date}">Event Date</td>
                        <td th:text="${e.time}">Event Time</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div th:if="${events.?[date != null and date.isBefore(T(java.time.LocalDate).now())].empty}">
            <p class="text-muted text-center">There are no previous events.</p>
        </div>

        <div th:if="${ok_message}" class="alert alert-success text-center mt-4">
            <i class="fa-solid fa-check-circle"></i>
            <span th:text="${ok_message}"></span>
        </div>

        <div class="mb-4">
            <h4 class="text-secondary mb-3">Events Map</h4>
            <div id="map"></div>
        </div>

        <!-- Mastodon Timeline Section -->
        <div class="mb-4">
            <h4 class="text-secondary mb-3">Mastodon Timeline</h4>
            <div class="card">
                <div class="card-body">
                    <div th:if="${mastodonPosts != null and !mastodonPosts.empty}">
                        <div class="list-group">
                            <a th:each="post : ${mastodonPosts}" 
                               th:href="${'https://mstdn.jp/@' + post.account.username + '/' + post.id}" 
                               target="_blank" 
                               class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1" th:text="${post.account.displayName}">User</h5>
                                    <div>
                                        <small class="text-muted me-2" th:text="${#dates.format(post.createdAt, 'yyyy-MM-dd')}">Date</small>
                                        <small class="text-muted" th:text="${#dates.format(post.createdAt, 'HH:mm')}">Time</small>
                                    </div>
                                </div>
                                <p class="mb-1" th:utext="${post.content}">Content</p>
                            </a>
                        </div>
                    </div>
                    <div th:if="${mastodonPosts == null or mastodonPosts.empty}" class="text-center text-muted py-3">
                        <p>No Mastodon posts available.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" 
        crossorigin="anonymous"></script>
    
</body>
</html>
